generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  id                BigInt        @id @default(autoincrement())
  nickname          String        @unique @db.VarChar(50)
  email             String        @unique @db.VarChar(100)
  password          String        @db.VarChar(255)
  lastLoginDate     DateTime?     @db.Timestamp
  role              Role          @default(STUDENT)
  createdCourses    Courses[]
  createdTests      Tests[]
  courseEnrollments Enrollments[]
  testResults       TestResults[]
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

model Categories {
  id          BigInt    @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  description String?   @db.Text
  courses     Courses[]
}

model Courses {
  id               BigInt              @id @default(autoincrement())
  creatorId        BigInt
  categoryId       BigInt
  testId           BigInt?
  title            String              @db.VarChar(255)
  description      String?             @db.Text
  difficultyLevel  Difficulty
  creationDate     DateTime            @default(now()) @db.Timestamp
  modificationDate DateTime            @default(now()) @updatedAt @db.Timestamp
  studentCount     Int                 @default(0)
  status           CourseStatus        @default(DRAFT)
  creator          Users               @relation(fields: [creatorId], references: [id])
  category         Categories          @relation(fields: [categoryId], references: [id])
  test             Tests?              @relation("CoursesToTests")
  courseElements   CourseElements[]
  enrollments      Enrollments[]
  courseOrder      CourseElementOrder?
}

enum Difficulty {
  BASIC
  INTERMEDIATE
  ADVANCED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Tests {
  id           BigInt          @id @default(autoincrement())
  creatorId    BigInt
  courseId     BigInt          @unique
  title        String          @db.VarChar(255)
  duration     Int // in minutes
  creationDate DateTime        @default(now()) @db.Timestamp
  creator      Users           @relation(fields: [creatorId], references: [id])
  course       Courses         @relation("CoursesToTests", fields: [courseId], references: [id])
  questions    TestQuestions[]
  testResults  TestResults[]
}

model TestQuestions {
  id           BigInt       @id @default(autoincrement())
  testId       BigInt
  content      String       @db.Text
  questionType QuestionType
  points       Int          @default(1)
  order        Int
  test         Tests        @relation(fields: [testId], references: [id])
  answers      Answers[]
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
}

model Answers {
  id         BigInt        @id @default(autoincrement())
  questionId BigInt
  content    String        @db.Text
  isCorrect  Boolean       @default(false)
  order      Int
  question   TestQuestions @relation(fields: [questionId], references: [id])
}

model CourseElementOrder {
  courseId  BigInt  @id
  lastOrder Int     @default(1)
  course    Courses @relation(fields: [courseId], references: [id])
}

model CourseElements {
  id             BigInt      @id @default(autoincrement())
  courseId       BigInt
  type           ElementType
  content        String      @db.Text
  order          Int
  additionalData Json?
  course         Courses     @relation(fields: [courseId], references: [id])
}

enum ElementType {
  HEADER
  TEXT
  IMAGE
  VIDEO
  FILE
  CODE
}

model Enrollments {
  id             BigInt           @id @default(autoincrement())
  courseId       BigInt
  userId         BigInt
  enrollmentDate DateTime         @default(now()) @db.Timestamp
  status         EnrollmentStatus @default(ACTIVE)
  progress       Int              @default(0) // in %
  course         Courses          @relation(fields: [courseId], references: [id])
  user           Users            @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

model TestResults {
  id        BigInt       @id @default(autoincrement())
  testId    BigInt
  userId    BigInt
  result    Int // in %
  startDate DateTime     @db.Timestamp
  endDate   DateTime?    @db.Timestamp
  status    ResultStatus @default(IN_PROGRESS)
  test      Tests        @relation(fields: [testId], references: [id])
  user      Users        @relation(fields: [userId], references: [id])
}

enum ResultStatus {
  IN_PROGRESS
  FINISHED
  GRADED
}
